document.addEventListener("DOMContentLoaded",()=>{
    const e=document.querySelector(".region-name"),
    t=document.querySelector(".data_type"),
    n=document.querySelector(".form-data"),
    r=document.querySelector(".errors"),
    o=document.querySelector(".clear-btn");
    if(!e||!t||!n)return;try{
        t.type="password"
    }catch(e){}
    const s=document.createElement("button");
    function a(e){
        return"string"==typeof e&&e.trim().length>=20
    }function i(e){
        if("string"!=typeof e)return!1;
        const t=e.trim().toUpperCase();
        return/^[A-Z]{2}(?:-[A-Z0-9]+)*$/.test(t)}function c(e,t){e&&(e.style.outline="none",e.style.borderWidth="2px",e.style.borderStyle="solid",e.style.borderColor=t?"green":"red",e.setAttribute("aria-invalid",(!t).toString()))}function l(e){e&&(e.style.borderColor="",e.style.borderWidth="",e.style.borderStyle="",e.removeAttribute("aria-invalid"))}function d(e,t){const n=`https://api.electricitymaps.com/v3/carbon-intensity/latest?zone=${encodeURIComponent(e)}`;return fetch(n,{headers:{Authorization:"Bearer "+t,Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Network response was not ok: "+e.status);return e.json().then(e=>({ok:!0,data:e}))}).catch(e=>({ok:!1,error:e.message}))}s.type="button",s.className="toggle-api-visibility",s.textContent="Show",s.setAttribute("aria-pressed","false"),s.style.marginLeft="8px",t.parentNode.insertBefore(s,t.nextSibling),s.addEventListener("click",()=>{"password"===t.type?(t.type="text",s.textContent="Hide",s.setAttribute("aria-pressed","true")):(t.type="password",s.textContent="Show",s.setAttribute("aria-pressed","false"))}),e.addEventListener("input",()=>{const t=i(e.value);c(e,t)}),t.addEventListener("input",()=>{const e=a(t.value);c(t,e)}),n.addEventListener("submit",n=>{r.textContent="";const o=a(t.value),s=i(e.value);if(!o||!s){if(n.preventDefault(),!s){const e=document.createElement("p");e.textContent='Region code invalid. Use formats like "US-NEISO" or "CM".',r.appendChild(e)}if(!o){const e=document.createElement("p");e.textContent="API key must be at least 20 characters long.",r.appendChild(e)}return r.style.color="red",r.setAttribute("role","alert"),c(e,s),c(t,o),!1}n.preventDefault(),c(e,!0),c(t,!0),r.textContent="";const l=document.querySelector(".loading"),u=document.querySelector(".data"),y=document.querySelector(".result-container");l&&(l.style.display="block"),u&&(u.textContent="");const p={action:"fetchCarbon",apiKey:t.value.trim(),region:e.value.trim()};function m(t){if(l&&(l.style.display="none"),!t)return void(r.textContent="No response from background.");if(!t.ok)return void(r.textContent=t.error||"Failed to fetch data.");const n=t.data||t.json||t,o=n.zone||n.data?.zone||e.value.trim(),s=(n.carbonIntensity??n.data?.carbonIntensity??n.mean??n.carbon)||"N/A",a=n.fossilFuelPercentage??n.data?.fossil??n.fossilFuel??"N/A";y&&(y.style.display="block");const i=document.querySelector(".my-region"),c=document.querySelector(".carbon-usage"),d=document.querySelector(".fossil-fuel");i&&(i.textContent=o),c&&(c.textContent=s),d&&(d.textContent=a)}if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage)try{chrome.runtime.sendMessage(p,e=>{m(e)})}catch(e){d(p.region,p.apiKey).then(m).catch(e=>{l&&(l.style.display="none"),r.textContent=e.message||String(e)})}else"undefined"!=typeof browser&&browser.runtime&&browser.runtime.sendMessage?browser.runtime.sendMessage(p).then(m).catch(e=>{l&&(l.style.display="none"),r.textContent=e.message||String(e)}):d(p.region,p.apiKey).then(m).catch(e=>{l&&(l.style.display="none"),r.textContent=e.message||String(e)});return!1}),o&&o.addEventListener("click",()=>{l(e),l(t),r.textContent="";try{t.type="password",s.textContent="Show",s.setAttribute("aria-pressed","false")}catch(e){}})});
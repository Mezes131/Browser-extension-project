(()=>{"use strict";document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".region-name"),t=document.querySelector("#data_type"),n=document.querySelector(".form-data"),o=document.querySelector(".errors"),r=document.querySelector(".clear-btn");if(!e||!t||!n)return;const s=["carbon-intensity","electricity-mix"];function a(e){return"string"==typeof e&&s.includes(e)}function i(e){if("string"!=typeof e)return!1;const t=e.trim().toUpperCase();return/^[A-Z]{2}(?:-[A-Z0-9]+)*$/.test(t)}function c(e,t){e&&(e.style.outline="none",e.style.borderWidth="2px",e.style.borderStyle="solid",e.style.borderColor=t?"green":"red",e.setAttribute("aria-invalid",(!t).toString()))}function d(e){e&&(e.style.borderColor="",e.style.borderWidth="",e.style.borderStyle="",e.removeAttribute("aria-invalid"))}function l(e,t){const n=`https://api.electricitymaps.com/v3/${encodeURIComponent(t)}/latest?zone=${encodeURIComponent(e)}`;fetch(n,{method:"GET",headers:{"auth-token":"2ZSwFDfr07A6PgRvMLwK"}}).then(e=>e.json()).catch(e=>({ok:!1,error:e.message}))}e.addEventListener("input",()=>{const t=i(e.value);c(e,t)}),t.addEventListener("change",()=>{const e=a(t.value);c(t,e)}),n.addEventListener("submit",n=>{o.textContent="";const r=a(t.value),s=i(e.value);if(!r||!s){if(n.preventDefault(),!s){const e=document.createElement("p");e.textContent='Region code invalid. Use formats like "US-NEISO" or "CM".',o.appendChild(e)}if(!r){const e=document.createElement("p");e.textContent="Please select a valid data type.",o.appendChild(e)}return o.style.color="red",o.setAttribute("role","alert"),c(e,s),c(t,r),!1}n.preventDefault(),c(e,!0),c(t,!0),o.textContent="";const d=document.querySelector(".loading"),u=document.querySelector(".data"),m=document.querySelector(".result-container");d&&(d.style.display="block"),u&&(u.textContent="");const y={action:"fetchCarbon",data_type:t.value,region:e.value.trim()};function f(t){if(d&&(d.style.display="none"),!t)return void(o.textContent="No response from background.");if(!t.ok)return void(o.textContent=t.error||"Failed to fetch data.");const n=t.data||t.json||t,r=n.zone||n.data?.zone||e.value.trim(),s=(n.carbonIntensity??n.data?.carbonIntensity??n.mean??n.carbon)||"N/A",a=n.fossilFuelPercentage??n.data?.fossil??n.fossilFuel??"N/A";m&&(m.style.display="block");const i=document.querySelector(".my-region"),c=document.querySelector(".carbon-usage"),l=document.querySelector(".fossil-fuel");i&&(i.textContent=r),c&&(c.textContent=s),l&&(l.textContent=a)}if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage)try{chrome.runtime.sendMessage(y,e=>{f(e)})}catch(e){l(y.region).then(f).catch(e=>{d&&(d.style.display="none"),o.textContent=e.message||String(e)})}else"undefined"!=typeof browser&&browser.runtime&&browser.runtime.sendMessage?browser.runtime.sendMessage(y).then(f).catch(e=>{d&&(d.style.display="none"),o.textContent=e.message||String(e)}):l(y.region).then(f).catch(e=>{d&&(d.style.display="none"),o.textContent=e.message||String(e)});return!1}),r&&r.addEventListener("click",()=>{d(e),d(t),o.textContent=""})})})();